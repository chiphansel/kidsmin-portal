-- =========================================================
-- KidsMin Portal — Initial Schema (UUID BINARY(16)) + Seed
-- MySQL 8.0.13+ (UUID_TO_BIN / BIN_TO_UUID)
-- =========================================================

-- Remove any preexisting events tables (redesign later)
SET FOREIGN_KEY_CHECKS = 0;
DROP TABLE IF EXISTS `event`;
DROP TABLE IF EXISTS `events`;
SET FOREIGN_KEY_CHECKS = 1;

-- 0) Database
CREATE DATABASE IF NOT EXISTS kidsmin_dev
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_0900_ai_ci;
USE kidsmin_dev;
SET NAMES utf8mb4 COLLATE utf8mb4_0900_ai_ci;

-- 1) individual (PK as BINARY(16))
CREATE TABLE IF NOT EXISTS individual (
  id             BINARY(16)  NOT NULL,                          -- UUID (binary)
  id_uuid        CHAR(36)     AS (BIN_TO_UUID(id)) VIRTUAL,     -- convenience (no storage)

  first_name     VARCHAR(64)  NOT NULL,
  last_name      VARCHAR(64)  NOT NULL,
  display_name   VARCHAR(128) NOT NULL,
  grade          VARCHAR(32)  NOT NULL DEFAULT 'Adult',
  special        BOOLEAN      NOT NULL DEFAULT FALSE
                                 CHECK (special IN (0,1)),
  created_by     BINARY(16)            DEFAULT NULL,            -- FK -> individual.id
  created_at     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (id),
  KEY idx_individual_display_name (display_name),
  KEY idx_individual_last_name (last_name),
  CONSTRAINT fk_individual_created_by
    FOREIGN KEY (created_by) REFERENCES individual(id) ON DELETE SET NULL
) ENGINE=InnoDB;

-- 2) credentials (1:1 with individual; email unique; is_active BOOLEAN DEFAULT TRUE)
CREATE TABLE IF NOT EXISTS credentials (
  id             BINARY(16)   NOT NULL,                         -- UUID (binary)
  id_uuid        CHAR(36)     AS (BIN_TO_UUID(id)) VIRTUAL,

  individual_id  BINARY(16)   NOT NULL,                         -- FK -> individual.id
  email          VARCHAR(254) NOT NULL,
  password_hash  CHAR(60)              DEFAULT NULL,            -- bcrypt
  is_active      BOOLEAN      NOT NULL DEFAULT TRUE
                               CHECK (is_active IN (0,1)),
  created_at     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (id),
  UNIQUE KEY uk_credentials_individual (individual_id),
  UNIQUE KEY uk_credentials_email (email),
  CONSTRAINT fk_credentials_individual
    FOREIGN KEY (individual_id) REFERENCES individual(id) ON DELETE CASCADE
) ENGINE=InnoDB;

-- 3) entity (hierarchy: DENOMINATION → NATIONAL → REGIONAL → DISTRICT → CHURCH)
CREATE TABLE IF NOT EXISTS entity (
  id         BINARY(16)   NOT NULL,                             -- UUID (binary)
  id_uuid    CHAR(36)     AS (BIN_TO_UUID(id)) VIRTUAL,

  name       VARCHAR(160) NOT NULL,
  level      ENUM('DENOMINATION','NATIONAL','REGIONAL','DISTRICT','CHURCH') NOT NULL,
  parent_id  BINARY(16)            DEFAULT NULL,                -- FK -> entity.id
  created_at DATETIME      NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME      NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (id),
  KEY idx_entity_level (level),
  KEY idx_entity_parent (parent_id),
  UNIQUE KEY uk_entity_hierarchy (parent_id, level, name),      -- smaller cols first
  CONSTRAINT fk_entity_parent
    FOREIGN KEY (parent_id) REFERENCES entity(id) ON DELETE SET NULL
) ENGINE=InnoDB;

-- 4) role_assignment (who has which role on which entity)
CREATE TABLE IF NOT EXISTS role_assignment (
  id             BINARY(16)   NOT NULL,                         -- UUID (binary)
  id_uuid        CHAR(36)     AS (BIN_TO_UUID(id)) VIRTUAL,

  individual_id  BINARY(16)   NOT NULL,                         -- FK -> individual.id
  target_type    ENUM('ENTITY') NOT NULL DEFAULT 'ENTITY',
  target_id      BINARY(16)   NOT NULL,                         -- FK -> entity.id
  role           ENUM('CMC','CDR','POG','COACH','ADMIN') NOT NULL,
  active         DATE         NOT NULL DEFAULT '9999-12-31',    -- 'active through' date
  created_at     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at     DATETIME     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (id),
  -- Hot-path index for menu/dashboard: WHERE individual_id=? AND active='9999-12-31' JOIN entity ON target_id
  KEY idx_ra_ind_active_target (individual_id, active, target_id),
  KEY idx_ra_target (target_id),
  UNIQUE KEY uk_role_assignment_unique (individual_id, target_type, target_id, role, active),

  CONSTRAINT fk_role_assignment_individual
    FOREIGN KEY (individual_id) REFERENCES individual(id) ON DELETE CASCADE,
  CONSTRAINT fk_role_assignment_entity
    FOREIGN KEY (target_id)     REFERENCES entity(id)     ON DELETE CASCADE
) ENGINE=InnoDB;

-- 5) Minimal seed (generate UUIDs in-SQL)
-- Insert Default Denomination (only if not present)
INSERT INTO entity (id, name, level, parent_id)
SELECT UUID_TO_BIN(UUID()), 'Default Denomination', 'DENOMINATION', NULL
WHERE NOT EXISTS (
  SELECT 1 FROM entity
   WHERE name='Default Denomination' AND level='DENOMINATION' AND parent_id IS NULL
);

-- Insert National Office under that Denomination (only if not present)
INSERT INTO entity (id, name, level, parent_id)
SELECT UUID_TO_BIN(UUID()), 'National Office', 'NATIONAL', d.id
FROM entity d
WHERE d.name='Default Denomination' AND d.level='DENOMINATION'
  AND NOT EXISTS (
    SELECT 1 FROM entity e
     WHERE e.name='National Office' AND e.level='NATIONAL' AND e.parent_id = d.id
  );

INSERT INTO entity (id, name, level, parent_id) VALUES
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000000'), 'National', 'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000001'), 'Northwest', 'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000002'), 'North Central', 'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000003'), 'Southwest', 'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000004'), 'South Central', 'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000005'), 'Gulf', 'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000006'), 'Southeast', 'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000007'), 'Great Lakes', 'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000008'), 'Northeast', 'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000009'), 'Alaska', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000001')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000010'), 'Northwest', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000001')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000011'), 'Montana', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000001')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000012'), 'Oregon', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000001')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000013'), 'South Idaho', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000001')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000014'), 'Wyoming', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000001')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000015'), 'North Dakota', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000002')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000016'), 'South Dakota', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000002')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000017'), 'Nebraska', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000002')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000018'), 'Minnesota', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000002')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000019'), 'Iowa', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000002')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000020'), 'Wisconsin / Northern Michigan', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000002')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000021'), 'Northern Missouri', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000002')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000022'), 'Northern California / Nevada', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000003')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000023'), 'Rocky Mountain', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000003')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000024'), 'Southern California', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000003')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000025'), 'Arizona', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000003')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000026'), 'Hawaii', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000003')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000027'), 'Kansas', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000004')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000028'), 'Oklahoma', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000004')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000029'), 'New Mexico', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000004')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000030'), 'West Texas', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000004')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000031'), 'North Texas', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000004')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000032'), 'South Texas', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000004')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000033'), 'Southern Missouri', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000005')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000034'), 'Arkansas', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000005')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000035'), 'Tennesee', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000005')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000036'), 'Mississippi', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000005')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000037'), 'Lousiana', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000005')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000038'), 'North Carolina', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000006')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000039'), 'South Carolina', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000006')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000040'), 'Alabama', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000006')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000041'), 'Georgia', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000006')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000042'), 'West Florida', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000006')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000043'), 'Peninsula Florida', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000006')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000044'), 'Puerto Rico', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000006')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000045'), 'Michigan', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000007')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000046'), 'Illinois', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000007')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000047'), 'Indiana', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000007')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000048'), 'Ohio', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000007')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000049'), 'Kentucky', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000007')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000050'), 'Appalachian', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000008')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000051'), 'Potomac', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000008')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000052'), 'Pennsylvania - Delaware', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000008')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000053'), 'New Jersey', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000008')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000054'), 'New York', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000008')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000055'), 'Southern New England', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000008')),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000056'), 'Northern New England', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000008'))
ON DUPLICATE KEY UPDATE name=VALUES(name), level=VALUES(level), parent_id=VALUES(parent_id);
