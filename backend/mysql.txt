-- =====================================================================
-- KidsMin Portal — Full Schema (UUID/BINARY(16) + Seeded Entities)
-- MySQL 8.x
-- UUIDs use UUID_TO_BIN(uuid, 1) / BIN_TO_UUID(bin, 1) for index locality.
-- CHANGE: denomination.id is BIGINT AUTO_INCREMENT (not UUID).
-- =====================================================================

DROP DATABASE IF EXISTS kidsmin;
CREATE DATABASE kidsmin
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_0900_ai_ci;
USE kidsmin;

SET NAMES utf8mb4;
SET time_zone = '+00:00';

-- Drop in FK-safe order
SET FOREIGN_KEY_CHECKS = 0;
DROP VIEW IF EXISTS v_active_roles;
DROP VIEW IF EXISTS v_entity_text;
DROP TABLE IF EXISTS role_assignment;
DROP TABLE IF EXISTS twofactor_challenge;
DROP TABLE IF EXISTS credentials;
DROP TABLE IF EXISTS individual;
DROP TABLE IF EXISTS entity;
DROP TABLE IF EXISTS denomination;
SET FOREIGN_KEY_CHECKS = 1;

-- =====================================================================
-- Reference tables
-- =====================================================================

-- Denominations (BIGINT id)
CREATE TABLE denomination (
  id         BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  name       VARCHAR(200)  NOT NULL,
  code       VARCHAR(32)   NULL,
  created_at TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY uq_denomination_code (code)
) ENGINE=InnoDB;

-- Entities (hierarchy, UUID ids)
CREATE TABLE entity (
  id              BINARY(16) NOT NULL,
  name            VARCHAR(200) NOT NULL,
  level           ENUM('DENOMINATION','NATIONAL','REGIONAL','DISTRICT','CHURCH') NOT NULL,
  parent_id       BINARY(16) NULL,
  denomination_id BIGINT UNSIGNED NULL,
  created_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  KEY idx_entity_level (level),
  KEY idx_entity_parent (parent_id),
  KEY idx_entity_denom (denomination_id),
  CONSTRAINT fk_entity_parent FOREIGN KEY (parent_id) REFERENCES entity(id) ON DELETE SET NULL,
  CONSTRAINT fk_entity_denom  FOREIGN KEY (denomination_id) REFERENCES denomination(id) ON DELETE SET NULL
) ENGINE=InnoDB;

-- People (UUID ids)
CREATE TABLE individual (
  id          BINARY(16)   NOT NULL,
  first_name  VARCHAR(100) NOT NULL,
  last_name   VARCHAR(100) NOT NULL,
  grade       ENUM('Adult','12','11','10','9') NOT NULL DEFAULT 'Adult',
  special     TINYINT(1)   NOT NULL DEFAULT 0,
  created_by  BINARY(16)   NULL,
  created_at  TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at  TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  KEY idx_individual_name (last_name, first_name),
  KEY idx_individual_grade (grade),
  CONSTRAINT fk_individual_creator FOREIGN KEY (created_by) REFERENCES individual(id) ON DELETE SET NULL
) ENGINE=InnoDB;

-- =====================================================================
-- Auth: credentials (+ phone & 2FA prefs) + single-row 2FA challenge
-- =====================================================================

CREATE TABLE credentials (
  id             BINARY(16)   NOT NULL,
  individual_id  BINARY(16)   NOT NULL,
  email          VARCHAR(320) NOT NULL,
  email_lc       VARCHAR(320) GENERATED ALWAYS AS (LOWER(email)) STORED,
  phone_e164     VARCHAR(20)  NULL,  -- e.g., +15551234567
  twofa_preferred ENUM('email','sms') NOT NULL DEFAULT 'email',
  twofa_enabled  TINYINT(1)   NOT NULL DEFAULT 0,
  password_hash  VARCHAR(255) NULL,
  is_active      TINYINT(1)   NOT NULL DEFAULT 0,
  last_login     TIMESTAMP    NULL,
  created_at     TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at     TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY uq_credentials_individual (individual_id),
  UNIQUE KEY uq_credentials_email_ci (email_lc),
  KEY idx_credentials_active (is_active),
  CONSTRAINT fk_credentials_individual FOREIGN KEY (individual_id) REFERENCES individual(id) ON DELETE CASCADE,
  CONSTRAINT chk_credentials_phone CHECK (phone_e164 IS NULL OR phone_e164 REGEXP '^\\+[0-9]{7,15}$')
) ENGINE=InnoDB;

-- Single-row 2FA challenge per credentials
CREATE TABLE twofactor_challenge (
  credentials_id BINARY(16)  NOT NULL,
  code_hash      VARCHAR(255) NOT NULL,
  channel        ENUM('email','sms') NOT NULL DEFAULT 'email',
  attempts       TINYINT UNSIGNED NOT NULL DEFAULT 0,
  expires_at     TIMESTAMP NOT NULL,
  created_at     TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at     TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (credentials_id),
  KEY idx_tfc_expires (expires_at),
  CONSTRAINT fk_tfc_credentials FOREIGN KEY (credentials_id) REFERENCES credentials(id) ON DELETE CASCADE
) ENGINE=InnoDB;

-- =====================================================================
-- Roles & assignments (UUID ids)
-- =====================================================================

CREATE TABLE role_assignment (
  id             BINARY(16)  NOT NULL,
  individual_id  BINARY(16)  NOT NULL,
  target_type    ENUM('ENTITY') NOT NULL DEFAULT 'ENTITY',
  target_id      BINARY(16)  NOT NULL,  -- references entity.id
  role           ENUM('CMC','CDR','POG','COACH','ADMIN') NOT NULL,
  active         DATE        NOT NULL DEFAULT '9999-12-31',
  created_at     TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at     TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  KEY idx_ra_individual (individual_id),
  KEY idx_ra_target (target_type, target_id),
  KEY idx_ra_active (active),
  CONSTRAINT fk_ra_individual FOREIGN KEY (individual_id) REFERENCES individual(id) ON DELETE CASCADE,
  CONSTRAINT fk_ra_entity     FOREIGN KEY (target_id)     REFERENCES entity(id)     ON DELETE CASCADE
) ENGINE=InnoDB;

-- =====================================================================
-- Auto-ID triggers (generate UUID if NULL on insert) — not used for denomination
-- =====================================================================

DELIMITER $$

CREATE TRIGGER trg_entity_bi
BEFORE INSERT ON entity
FOR EACH ROW
BEGIN
  IF NEW.id IS NULL THEN SET NEW.id = UUID_TO_BIN(UUID(), 1); END IF;
END$$

CREATE TRIGGER trg_individual_bi
BEFORE INSERT ON individual
FOR EACH ROW
BEGIN
  IF NEW.id IS NULL THEN SET NEW.id = UUID_TO_BIN(UUID(), 1); END IF;
END$$

CREATE TRIGGER trg_credentials_bi
BEFORE INSERT ON credentials
FOR EACH ROW
BEGIN
  IF NEW.id IS NULL THEN SET NEW.id = UUID_TO_BIN(UUID(), 1); END IF;
END$$

CREATE TRIGGER trg_role_assignment_bi
BEFORE INSERT ON role_assignment
FOR EACH ROW
BEGIN
  IF NEW.id IS NULL THEN SET NEW.id = UUID_TO_BIN(UUID(), 1); END IF;
END$$

DELIMITER ;

-- =====================================================================
-- Helpful views (UUIDs as text for debugging)
-- =====================================================================

DROP VIEW IF EXISTS v_entity_text;
CREATE VIEW v_entity_text AS
SELECT
  BIN_TO_UUID(e.id, 1)               AS id,
  e.name,
  e.level,
  BIN_TO_UUID(e.parent_id, 1)        AS parent_id,
  e.denomination_id,
  e.created_at, e.updated_at
FROM entity e;

DROP VIEW IF EXISTS v_active_roles;
CREATE VIEW v_active_roles AS
SELECT
  BIN_TO_UUID(ra.id, 1)              AS id,
  BIN_TO_UUID(ra.individual_id, 1)   AS individual_id,
  ra.target_type,
  BIN_TO_UUID(ra.target_id, 1)       AS target_id,
  e.name                              AS target_name,
  e.level                             AS target_level,
  ra.role,
  ra.active,
  ra.created_at,
  ra.updated_at
FROM role_assignment ra
LEFT JOIN entity e ON e.id = ra.target_id
WHERE ra.active = '9999-12-31';

-- =====================================================================
-- Seeds
-- =====================================================================

-- 1) Default denomination
INSERT INTO denomination (name, code)
VALUES ('Default', 'DEFAULT')
ON DUPLICATE KEY UPDATE name=VALUES(name), code=VALUES(code);

-- 2) Entities (National -> Regions -> Districts), with stable UUIDs
-- National (parent NULL)
INSERT INTO entity (id, name, level, parent_id)
VALUES (UUID_TO_BIN('00000000-0000-0000-0000-000000000000', 1), 'National', 'NATIONAL', NULL)
AS new
ON DUPLICATE KEY UPDATE name=new.name, level=new.level, parent_id=new.parent_id;

-- Regions (parent = National)
INSERT INTO entity (id, name, level, parent_id) VALUES
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000001', 1), 'Northwest',     'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000002', 1), 'North Central', 'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000003', 1), 'Southwest',     'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000004', 1), 'South Central', 'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000005', 1), 'Gulf',          'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000006', 1), 'Southeast',     'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000007', 1), 'Great Lakes',   'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000008', 1), 'Northeast',     'REGIONAL', UUID_TO_BIN('00000000-0000-0000-0000-000000000000', 1))
AS new
ON DUPLICATE KEY UPDATE name=new.name, level=new.level, parent_id=new.parent_id;

-- Districts under each Region
INSERT INTO entity (id, name, level, parent_id) VALUES
  -- Region: Northwest (…0001)
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000009', 1), 'Alaska',      'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000001', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000010', 1), 'Northwest',   'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000001', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000011', 1), 'Montana',     'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000001', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000012', 1), 'Oregon',      'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000001', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000013', 1), 'South Idaho', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000001', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000014', 1), 'Wyoming',     'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000001', 1)),

  -- Region: North Central (…0002)
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000015', 1), 'North Dakota',  'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000002', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000016', 1), 'South Dakota',  'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000002', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000017', 1), 'Nebraska',      'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000002', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000018', 1), 'Minnesota',     'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000002', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000019', 1), 'Iowa',          'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000002', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000020', 1), 'Wisconsin / Northern Michigan', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000002', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000021', 1), 'Northern Missouri', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000002', 1)),

  -- Region: Southwest (…0003)
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000022', 1), 'Northern California / Nevada', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000003', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000023', 1), 'Rocky Mountain', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000003', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000024', 1), 'Southern California', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000003', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000025', 1), 'Arizona',         'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000003', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000026', 1), 'Hawaii',          'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000003', 1)),

  -- Region: South Central (…0004)
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000027', 1), 'Kansas',      'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000004', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000028', 1), 'Oklahoma',    'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000004', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000029', 1), 'New Mexico',  'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000004', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000030', 1), 'West Texas',  'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000004', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000031', 1), 'North Texas', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000004', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000032', 1), 'South Texas', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000004', 1)),

  -- Region: Gulf (…0005)
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000033', 1), 'Southern Missouri', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000005', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000034', 1), 'Arkansas',        'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000005', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000035', 1), 'Tennessee',       'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000005', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000036', 1), 'Mississippi',     'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000005', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000037', 1), 'Louisiana',       'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000005', 1)),

  -- Region: Southeast (…0006)
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000038', 1), 'North Carolina',   'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000006', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000039', 1), 'South Carolina',   'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000006', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000040', 1), 'Alabama',          'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000006', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000041', 1), 'Georgia',          'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000006', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000042', 1), 'West Florida',     'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000006', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000043', 1), 'Peninsula Florida','DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000006', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000044', 1), 'Puerto Rico',      'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000006', 1)),

  -- Region: Great Lakes (…0007)
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000045', 1), 'Michigan',       'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000007', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000046', 1), 'Illinois',       'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000007', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000047', 1), 'Indiana',        'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000007', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000048', 1), 'Ohio',           'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000007', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000049', 1), 'Kentucky',       'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000007', 1)),

  -- Region: Northeast (…0008)
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000050', 1), 'Appalachian',        'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000008', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000051', 1), 'Potomac',            'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000008', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000052', 1), 'Pennsylvania - Delaware', 'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000008', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000053', 1), 'New Jersey',         'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000008', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000054', 1), 'New York',           'DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000008', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000055', 1), 'Southern New England','DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000008', 1)),
  (UUID_TO_BIN('00000000-0000-0000-0000-000000000056', 1), 'Northern New England','DISTRICT', UUID_TO_BIN('00000000-0000-0000-0000-000000000008', 1))
AS new
ON DUPLICATE KEY UPDATE name=new.name, level=new.level, parent_id=new.parent_id;

-- 3) Assign all seeded entities to the Default denomination (optional but handy)
SET @denom_id := (SELECT id FROM denomination WHERE code='DEFAULT' LIMIT 1);
UPDATE entity SET denomination_id = @denom_id WHERE denomination_id IS NULL;

-- =====================================================================
-- Usage notes
-- =====================================================================
-- Insert with generated UUID (efficient order):
--   INSERT INTO individual (id, first_name, last_name)
--   VALUES (UUID_TO_BIN(UUID(), 1), 'Jane', 'Doe');
-- Query with text UUIDs:
--   SELECT BIN_TO_UUID(id, 1) AS id, name, level FROM entity WHERE level='REGIONAL';
